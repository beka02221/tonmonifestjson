<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>TON & SOL — Charts</title>
  <!-- Отключаем масштабирование, делаем аккуратный mobile UI -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      /* dark */
      --bg:#0a0f16; --panel:#0f1521; --panel-2:#0b101a; --chart:#0f1624;
      --text:#e9f2ff; --muted:#a6b6cf; --grid:#22314a; --primary:#8fbcff; --accent:#39e0b2; --accent2:#8a5cf6;
      --ok:#66e4aa; --warn:#ffd479; --err:#ff8b8b;
      --br:#20324d; --shadow:0 12px 42px rgba(0,0,0,.45); --r:16px;
      --glow:0 0 18px rgba(57,224,178,.45),0 0 30px rgba(138,92,246,.35);
    }
    html[data-theme="light"]{
      --bg:#f7faff; --panel:#ffffff; --panel-2:#f3f7ff; --chart:#ffffff;
      --text:#0e1a2b; --muted:#667894; --grid:#dfe7f3; --primary:#3b6ce0; --accent:#0ea5e9; --accent2:#8b5cf6;
      --ok:#059669; --warn:#d97706; --err:#dc2626;
      --br:#d7e1f1; --shadow:0 10px 28px rgba(0,0,0,.08); --r:16px;
      --glow:0 0 16px rgba(14,165,233,.35),0 0 26px rgba(139,92,246,.28);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.55 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--primary);text-decoration:none}

    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:4px 0 12px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;margin:0}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:var(--glow);animation:pulse 1.8s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn,.chip,.pill{border:1px solid var(--br);background:linear-gradient(180deg,var(--panel),var(--panel-2));color:var(--text);border-radius:12px}
    .btn{padding:9px 14px;cursor:pointer;transition:transform .15s, box-shadow .2s}
    .btn:hover{box-shadow:var(--glow)}
    .btn:active{transform:translateY(1px)}
    .chip{padding:6px 10px;cursor:pointer}
    .chip.active{box-shadow:var(--glow)}
    .pill{padding:6px 10px;display:inline-flex;align-items:center;gap:8px}
    .toggle{display:flex;align-items:center;gap:8px}
    .toggle input{appearance:none;width:44px;height:24px;border-radius:999px;background:var(--panel-2);border:1px solid var(--br);position:relative;cursor:pointer}
    .toggle input:checked{background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .toggle input::after{content:"";position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;left:3px;top:2.5px;transition:transform .2s}
    .toggle input:checked::after{transform:translateX(20px)}

    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width:980px){ .grid{grid-template-columns:1fr 1fr} }

    .card{border:1px solid var(--br);border-radius:var(--r);background:linear-gradient(180deg,var(--panel),var(--panel-2));
      box-shadow:var(--shadow);padding:12px;animation:fadeIn .35s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .card h3{margin:0 0 10px;display:flex;align-items:center;gap:10px;font-size:15px}
    .muted{color:var(--muted);font-size:12px}
    .subbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    .chart{height:44vh;min-height:260px;border-radius:12px;overflow:hidden;background:var(--chart)}
    @media (min-width:980px){ .chart{height:36vh} }

    .skeleton{position:relative;border:1px dashed var(--grid);border-radius:12px;height:44vh;min-height:260px;overflow:hidden}
    @media (min-width:980px){ .skeleton{height:36vh} }
    .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);transform:translateX(-100%);animation:sh 1.25s infinite}
    @keyframes sh{to{transform:translateX(100%)}}

    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%) translateY(12px);background:var(--panel);border:1px solid var(--br);
      padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .18s, transform .18s;z-index:50}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    .badges{display:flex;gap:10px;flex-wrap:wrap}
    .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--br);background:var(--panel);color:var(--muted)}

    /* Мобильная карусель: один чарт на экран + свайпы */
    .carousel{position:relative}
    .slides{display:flex;gap:14px;scroll-snap-type:x mandatory;overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;touch-action:pan-y}
    .slide{flex:0 0 100%;scroll-snap-align:start}
    .dots{display:flex;justify-content:center;gap:8px;margin-top:8px}
    .dotnav{width:8px;height:8px;border-radius:999px;background:var(--grid);transition:transform .2s, background .2s}
    .dotnav.active{background:linear-gradient(135deg,var(--accent),var(--accent2));transform:scale(1.2);box-shadow:var(--glow)}

    .navArrows{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
    .navBtn{pointer-events:auto;border:1px solid var(--br);background:var(--panel);width:38px;height:38px;border-radius:12px;display:grid;place-items:center;opacity:.9}
    .navBtn:active{transform:translateY(1px)}
    @media (min-width:980px){ .carousel, .slides, .slide, .navArrows, .dots{display:none} }

    .hidden{display:none!important}
  </style>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js" defer></script>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <h2 class="title"><span class="dot"></span>TON & SOL — MEXC Charts</h2>
    <div class="toolbar">
      <label class="toggle" title="Светлая/Тёмная тема"><input id="themeSwitch" type="checkbox"><span class="muted">Тема</span></label>
      <label class="toggle" title="Live обновление"><input id="liveSwitch" type="checkbox" checked><span class="muted">Live</span></label>
      <button class="btn" id="btnRefresh">↻ Обновить</button>
    </div>
  </div>

  <div class="hdr" style="margin-top:-6px">
    <div class="badges">
      <span class="badge" id="status">Статус: загрузка…</span>
      <span class="badge">TF: <span id="tfLabel">1m</span></span>
      <span class="badge">Тип: <span id="typeLabel">Candles</span></span>
      <span class="badge"><a href="https://api.mexc.com" target="_blank" rel="noreferrer">MEXC API</a></span>
    </div>
    <div class="toolbar">
      <div class="chip active" data-int="1m">1m</div>
      <div class="chip" data-int="5m">5m</div>
      <div class="chip" data-int="15m">15m</div>
      <div class="chip" id="btnType">Candles / Line</div>
    </div>
  </div>

  <!-- Десктопная сетка -->
  <div class="grid" id="gridDesktop">
    <div id="cardTon" class="card">
      <h3>TON/USDT</h3>
      <div class="subbar">
        <span class="pill">Now: <span id="tonNow">—</span></span>
        <span class="muted" id="tonTime">—</span>
      </div>
      <div id="tonChart" class="chart"></div>
      <div id="tonSkel" class="skeleton"></div>
    </div>

    <div id="cardSol" class="card">
      <h3>SOL/USDT</h3>
      <div class="subbar">
        <span class="pill">Now: <span id="solNow">—</span></span>
        <span class="muted" id="solTime">—</span>
      </div>
      <div id="solChart" class="chart"></div>
      <div id="solSkel" class="skeleton"></div>
    </div>

    <div id="cardIdx" class="card" style="grid-column:1/-1">
      <h3>INDEX = TON / SOL × 100</h3>
      <div class="subbar">
        <span class="pill">Now: <span id="idxNow">—</span></span>
        <span class="muted" id="idxTime">—</span>
      </div>
      <div id="idxChart" class="chart"></div>
      <div id="idxSkel" class="skeleton"></div>
      <div class="muted" style="margin-top:6px">История из <code>/klines</code>, live по <code>bookTicker</code>. Свечи по умолчанию.</div>
    </div>
  </div>

  <!-- Мобильная карусель (один чарт на экран + свайпы) -->
  <div class="carousel" id="carouselMobile">
    <div class="slides" id="slides">
      <section class="slide">
        <div class="card">
          <h3>TON/USDT</h3>
          <div class="subbar">
            <span class="pill">Now: <span id="tonNowM">—</span></span>
            <span class="muted" id="tonTimeM">—</span>
          </div>
          <div id="tonChartM" class="chart"></div>
          <div id="tonSkelM" class="skeleton"></div>
        </div>
      </section>
      <section class="slide">
        <div class="card">
          <h3>SOL/USDT</h3>
          <div class="subbar">
            <span class="pill">Now: <span id="solNowM">—</span></span>
            <span class="muted" id="solTimeM">—</span>
          </div>
          <div id="solChartM" class="chart"></div>
          <div id="solSkelM" class="skeleton"></div>
        </div>
      </section>
      <section class="slide">
        <div class="card">
          <h3>INDEX = TON / SOL × 100</h3>
          <div class="subbar">
            <span class="pill">Now: <span id="idxNowM">—</span></span>
            <span class="muted" id="idxTimeM">—</span>
          </div>
          <div id="idxChartM" class="chart"></div>
          <div id="idxSkelM" class="skeleton"></div>
        </div>
      </section>
    </div>
    <div class="navArrows">
      <button class="navBtn" id="prevBtn" aria-label="Предыдущий">◀</button>
      <button class="navBtn" id="nextBtn" aria-label="Следующий">▶</button>
    </div>
    <div class="dots" id="dots">
      <div class="dotnav active"></div>
      <div class="dotnav"></div>
      <div class="dotnav"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast">Сообщение</div>

<script>
  // ========= CONSTS / HELPERS =========
  const API_BASE = "https://api.mexc.com/api/v3";
  const PROXIES = [
    (u) => `https://cors.isomorphic-git.org/${u}`,
    (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
    (u) => `https://r.jina.ai/http/${u.replace(/^https?:\/\//,'')}`
  ];
  const TON = "TONUSDT", SOL = "SOLUSDT";
  const LIMIT = 500;

  let INTERVAL = "1m";
  let CHART_TYPE = "candles"; // "candles" | "line"
  let liveTimer = null;

  const $ = id => document.getElementById(id);
  const qsa = (sel, root=document) => [...root.querySelectorAll(sel)];
  const fmt = (n,p=6)=> (n==null?"—":(+n).toFixed(p).replace(/\.?0+$/,""));
  const tsFmt = s => { const d=new Date(s*1000); return d.toISOString().replace('T',' ').slice(0,19)+' UTC'; };
  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() }

  function setStatus(text, ok=true){ const el=$("status"); el.textContent="Статус: "+text; el.style.color= ok ? "var(--ok)" : "var(--err)"; }
  function toast(msg, ms=1800){ const el=$("toast"); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), ms); }
  function showSk(id){ const el=$(id); if(el) el.style.display="block"; }
  function hideSk(id){ const el=$(id); if(el) el.style.display="none"; }

  // ========= THEME =========
  function setupTheme(){
    const saved = localStorage.getItem('theme');
    const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
    const initial = saved || (prefersLight ? 'light' : 'dark');
    document.documentElement.setAttribute('data-theme', initial);
    $("themeSwitch").checked = initial === 'light';
    $("themeSwitch").addEventListener('change', ()=>{
      const mode = $("themeSwitch").checked ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem('theme', mode);
      // обновить тему у всех графиков
      Object.values(Charts).forEach(obj => {
        if (obj.chart) obj.chart.applyOptions(themeChartOpts());
        if (obj.chartM) obj.chartM.applyOptions(themeChartOpts());
      });
    });
  }

  // ========= LAYOUT: Desktop grid vs Mobile carousel =========
  function updateLayout(){
    const isDesktop = window.matchMedia('(min-width: 980px)').matches;
    $("gridDesktop").style.display = isDesktop ? "" : "none";
    $("carouselMobile").style.display = isDesktop ? "none" : "";
  }
  window.addEventListener('resize', updateLayout);

  // ========= NETWORK =========
  function apiUrl(q){ return `${API_BASE}/${q}` }
  async function viaProxies(url, tries=3){
    let lastErr;
    for(let round=0; round<tries; round++){
      for(const build of PROXIES){
        const proxied = build(url);
        try{
          const r = await fetch(proxied, { cache:'no-store' });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const text = await r.text();
          let data; try { data = JSON.parse(text); } catch { data = JSON.parse(text.replace(/^[^{\[]+/,'')); }
          return data;
        }catch(e){ lastErr=e; await new Promise(res=>setTimeout(res, 250*(round+1))); }
      }
    }
    throw lastErr || new Error('All proxies failed');
  }
  async function mexcJSON(path){ return viaProxies(apiUrl(path), 3); }

  // ========= CHARTS ENGINE =========
  const Charts = {
    ton: { chart:null, series:null, type:null, chartM:null, seriesM:null, elDesktop:"tonChart", elMobile:"tonChartM", now:["tonNow","tonTime"], nowM:["tonNowM","tonTimeM"], sk:["tonSkel","tonSkelM"] },
    sol: { chart:null, series:null, type:null, chartM:null, seriesM:null, elDesktop:"solChart", elMobile:"solChartM", now:["solNow","solTime"], nowM:["solNowM","solTimeM"], sk:["solSkel","solSkelM"] },
    idx: { chart:null, series:null, type:'line', chartM:null, seriesM:null, elDesktop:"idxChart", elMobile:"idxChartM", now:["idxNow","idxTime"], nowM:["idxNowM","idxTimeM"], sk:["idxSkel","idxSkelM"] },
  };

  function themeChartOpts(){
    return {
      layout:{ background:{type:'solid', color:getVar('--chart')}, textColor:getVar('--text') },
      rightPriceScale:{ borderColor:getVar('--grid') },
      timeScale:{ borderColor:getVar('--grid'), timeVisible:true, secondsVisible:false, rightOffset:6, barSpacing:8 },
      grid:{ vertLines:{color:getVar('--grid')}, horzLines:{color:getVar('--grid')} },
      crosshair:{ mode:LightweightCharts.CrosshairMode.Magnet },
      handleScale:{ mouseWheel:true, pinch:true, axisPressedMouseMove:true },
      kineticScroll:{ mouse:true, touch:true },
    };
  }

  function createChartFor(containerId){
    const el = $(containerId);
    const c = LightweightCharts.createChart(el, themeChartOpts());
    const ro = new ResizeObserver(()=>c.resize(el.clientWidth||600, el.clientHeight||300));
    ro.observe(el);
    return c;
  }

  function setSeries(obj, type){
    if (obj.series){ obj.chart.removeSeries(obj.series); obj.series=null; }
    if (type === 'candles'){
      obj.series = obj.chart.addCandlestickSeries({ upColor:'#0ac18e', downColor:'#ff6b6b', wickUpColor:'#0ac18e', wickDownColor:'#ff6b6b', borderVisible:false });
    }else{
      obj.series = obj.chart.addLineSeries({ lineWidth:2 });
    }
    obj.type = type;
  }

  function applyTypeAll(type){
    // TON
    setSeries(Charts.ton, type);
    // SOL
    setSeries(Charts.sol, type);
    // INDEX — всегда линия
    setSeries(Charts.idx, 'line');
    $("typeLabel").textContent = type === 'candles' ? 'Candles' : 'Line';
  }

  // ========= DATA LOADING =========
  async function klines(symbol){
    const j = await mexcJSON(`klines?symbol=${symbol}&interval=${INTERVAL}&limit=${LIMIT}`);
    return j.map(a => ({
      time: Math.floor(a[0]/1000), open:+a[1], high:+a[2], low:+a[3], close:+a[4], value:+a[4]
    }));
  }
  async function bookMid(symbol){
    const j = await mexcJSON(`ticker/bookTicker?symbol=${symbol}`);
    const bid=+j.bidPrice, ask=+j.askPrice; return (bid+ask)/2;
  }

  function setNow(objKey, value, time){
    const o = Charts[objKey];
    const [nD,tD] = o.now; const [nM,tM] = o.nowM;
    $(nD).textContent = fmt(value,6); $(tD).textContent = tsFmt(time);
    $(nM).textContent = fmt(value,6); $(tM).textContent = tsFmt(time);
  }
  function showSkAll(objKey, show=true){
    const ids = Charts[objKey].sk;
    ids.forEach(id=> show ? showSk(id) : hideSk(id));
  }

  async function loadHistory(){
    setStatus('загрузка…', true);
    showSkAll('ton', true); showSkAll('sol', true); showSkAll('idx', true);

    const [t,s] = await Promise.all([klines(TON), klines(SOL)]);

    // Desktop charts
    if (!Charts.ton.chart) Charts.ton.chart = createChartFor(Charts.ton.elDesktop);
    if (!Charts.sol.chart) Charts.sol.chart = createChartFor(Charts.sol.elDesktop);
    if (!Charts.idx.chart) Charts.idx.chart = createChartFor(Charts.idx.elDesktop);
    applyTypeAll(CHART_TYPE);

    if (Charts.ton.type==='candles'){ Charts.ton.series.setData(t.map(p=>({time:p.time, open:p.open, high:p.high, low:p.low, close:p.close}))); }
    else { Charts.ton.series.setData(t.map(p=>({time:p.time, value:p.value}))); }

    if (Charts.sol.type==='candles'){ Charts.sol.series.setData(s.map(p=>({time:p.time, open:p.open, high:p.high, low:p.low, close:p.close}))); }
    else { Charts.sol.series.setData(s.map(p=>({time:p.time, value:p.value}))); }

    const smap = new Map(s.map(p=>[p.time,p.value]));
    const idx = t.filter(p=>smap.has(p.time)).map(p=>({time:p.time, value:(p.value/smap.get(p.time))*100}));
    Charts.idx.series.setData(idx);

    Charts.ton.chart.timeScale().fitContent();
    Charts.sol.chart.timeScale().fitContent();
    Charts.idx.chart.timeScale().fitContent();

    if (t.length){ const last=t.at(-1); setNow('ton', last.value, last.time); }
    if (s.length){ const last=s.at(-1); setNow('sol', last.value, last.time); }
    if (idx.length){ const last=idx.at(-1); setNow('idx', last.value, last.time); }

    // Mobile charts
    if (!Charts.ton.chartM) Charts.ton.chartM = createChartFor(Charts.ton.elMobile);
    if (!Charts.sol.chartM) Charts.sol.chartM = createChartFor(Charts.sol.elMobile);
    if (!Charts.idx.chartM) Charts.idx.chartM = createChartFor(Charts.idx.elMobile);

    if (Charts.ton.seriesM) Charts.ton.chartM.removeSeries(Charts.ton.seriesM);
    if (Charts.sol.seriesM) Charts.sol.chartM.removeSeries(Charts.sol.seriesM);
    if (Charts.idx.seriesM) Charts.idx.chartM.removeSeries(Charts.idx.seriesM);

    Charts.ton.seriesM = (CHART_TYPE==='candles')
      ? Charts.ton.chartM.addCandlestickSeries({ upColor:'#0ac18e', downColor:'#ff6b6b', wickUpColor:'#0ac18e', wickDownColor:'#ff6b6b', borderVisible:false })
      : Charts.ton.chartM.addLineSeries({ lineWidth:2 });
    Charts.sol.seriesM = (CHART_TYPE==='candles')
      ? Charts.sol.chartM.addCandlestickSeries({ upColor:'#0ac18e', downColor:'#ff6b6b', wickUpColor:'#0ac18e', wickDownColor:'#ff6b6b', borderVisible:false })
      : Charts.sol.chartM.addLineSeries({ lineWidth:2 });
    Charts.idx.seriesM = Charts.idx.chartM.addLineSeries({ lineWidth:2 });

    if (CHART_TYPE==='candles'){
      Charts.ton.seriesM.setData(t.map(p=>({time:p.time, open:p.open, high:p.high, low:p.low, close:p.close})));
      Charts.sol.seriesM.setData(s.map(p=>({time:p.time, open:p.open, high:p.high, low:p.low, close:p.close})));
    }else{
      Charts.ton.seriesM.setData(t.map(p=>({time:p.time, value:p.value})));
      Charts.sol.seriesM.setData(s.map(p=>({time:p.time, value:p.value})));
    }
    Charts.idx.seriesM.setData(idx);

    Charts.ton.chartM.timeScale().fitContent();
    Charts.sol.chartM.timeScale().fitContent();
    Charts.idx.chartM.timeScale().fitContent();

    showSkAll('ton', false); showSkAll('sol', false); showSkAll('idx', false);
    setStatus('онлайн', true);
    toast('Графики обновлены');
  }

  async function liveTickOnce(){
    try{
      const [tm, sm] = await Promise.all([bookMid(TON), bookMid(SOL)]);
      const now = Math.floor(Date.now()/1000);
      const iv = (tm/sm)*100;

      const upd = (series, val) => {
        if (CHART_TYPE==='candles') series.update({time:now, open:val, high:val, low:val, close:val});
        else series.update({time:now, value:val});
      };

      // Desktop
      upd(Charts.ton.series, tm);
      upd(Charts.sol.series, sm);
      Charts.idx.series.update({time:now, value:iv});
      // Mobile
      upd(Charts.ton.seriesM, tm);
      upd(Charts.sol.seriesM, sm);
      Charts.idx.seriesM.update({time:now, value:iv});

      setNow('ton', tm, now);
      setNow('sol', sm, now);
      setNow('idx', iv, now);
      setStatus('онлайн', true);
    }catch(e){ setStatus('прокси медлит…', false); }
  }

  function startLive(){ stopLive(); if ($("liveSwitch").checked){ liveTimer = setInterval(liveTickOnce, 1000); } }
  function stopLive(){ if (liveTimer){ clearInterval(liveTimer); liveTimer=null; } }

  // ========= MOBILE CAROUSEL (свайпы + стрелки + точки) =========
  function setupCarousel(){
    const slides = $("slides");
    const dots = qsa('.dotnav', $("dots"));
    const prev = $("prevBtn"), next = $("nextBtn");

    function index(){ return Math.round(slides.scrollLeft / slides.clientWidth); }
    function go(i){ slides.scrollTo({left: i*slides.clientWidth, behavior:'smooth'}); setDots(i); }
    function setDots(i){ dots.forEach((d,idx)=> d.classList.toggle('active', idx===i)); }

    let startX=0, startY=0;
    slides.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; startX=t.clientX; startY=t.clientY; }, {passive:true});
    slides.addEventListener('touchend', (e)=>{
      const dx=(e.changedTouches[0].clientX - startX), dy=(e.changedTouches[0].clientY - startY);
      if (Math.abs(dx)>50 && Math.abs(dy)<40){
        const i=index();
        if (dx<0 && i<2) go(i+1);
        if (dx>0 && i>0) go(i-1);
      }else{ setDots(index()); }
    }, {passive:true});

    slides.addEventListener('scroll', ()=>{ setDots(index()); }, {passive:true});

    prev.addEventListener('click', ()=>{ const i=index(); if(i>0) go(i-1); });
    next.addEventListener('click', ()=>{ const i=index(); if(i<2) go(i+1); });

    dots.forEach((d,idx)=> d.addEventListener('click', ()=>go(idx)));
  }

  // ========= INIT =========
  window.addEventListener('DOMContentLoaded', async ()=>{
    if (!window.LightweightCharts || typeof LightweightCharts.createChart !== 'function') {
      toast('Charts не загрузились. Проверь CDN.'); setStatus('ошибка библиотеки', false); return;
    }
    setupTheme(); updateLayout(); setupCarousel();

    // UI
    $("btnRefresh").addEventListener('click', async ()=>{ toast('⏳ Обновляю…'); await loadHistory(); await liveTickOnce(); });
    $("liveSwitch").addEventListener('change', ()=> startLive());

    qsa('.chip[data-int]').forEach(ch=>{
      ch.addEventListener('click', async ()=>{
        qsa('.chip[data-int]').forEach(c=>c.classList.remove('active'));
        ch.classList.add('active');
        INTERVAL = ch.dataset.int || '1m';
        $("tfLabel").textContent = INTERVAL;
        toast('Интервал: '+INTERVAL);
        await loadHistory();
      });
    });

    $("btnType").addEventListener('click', async ()=>{
      CHART_TYPE = (CHART_TYPE==='candles') ? 'line' : 'candles';
      $("typeLabel").textContent = CHART_TYPE==='candles' ? 'Candles' : 'Line';
      toast('Тип графика: '+$("typeLabel").textContent);
      await loadHistory();
    });

    try{
      await loadHistory();
      startLive();
    }catch(e){
      console.error(e);
      setStatus('ошибка инициализации (прокси)', false);
      toast('Публичные прокси недоступны. Перезагрузите страницу позже.');
    }
  });
</script>
</body>
</html>
