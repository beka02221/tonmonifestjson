<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>TON & SOL — Charts (PWA)</title>
  <!-- ВАЖНО: запрет масштабирования -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0b0f14" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#0a0f16; --panel:#0f1521; --panel-2:#0b101a; --chart:#0f1624;
      --text:#e9f2ff; --muted:#a6b6cf; --grid:#22314a; --primary:#8fbcff; --accent:#39e0b2; --accent2:#8a5cf6;
      --ok:#66e4aa; --warn:#ffd479; --err:#ff8b8b;
      --br:#20324d; --shadow:0 12px 42px rgba(0,0,0,.45); --r:16px;
      --glow:0 0 18px rgba(57,224,178,.45),0 0 30px rgba(138,92,246,.35);
    }
    html[data-theme="light"]{
      --bg:#f7faff; --panel:#ffffff; --panel-2:#f3f7ff; --chart:#ffffff;
      --text:#0e1a2b; --muted:#667894; --grid:#dfe7f3; --primary:#3b6ce0; --accent:#0ea5e9; --accent2:#8b5cf6;
      --ok:#059669; --warn:#d97706; --err:#dc2626;
      --br:#d7e1f1; --shadow:0 10px 28px rgba(0,0,0,.08); --r:16px;
      --glow:0 0 16px rgba(14,165,233,.35),0 0 26px rgba(139,92,246,.28);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.55 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;touch-action:manipulation}
    a{color:var(--primary);text-decoration:none}

    .app{min-height:100%;display:flex;flex-direction:column}
    .appbar{
      position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border-bottom:1px solid var(--br); box-shadow:var(--shadow);
    }
    .appbar-inner{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 14px;max-width:1200px;margin:0 auto}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;margin:0;font-size:16px}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:var(--glow);animation:pulse 1.8s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}

    .actions{display:flex;gap:10px;align-items:center}
    .btn{border:1px solid var(--br);background:linear-gradient(180deg,var(--panel),var(--panel-2));color:var(--text);
      border-radius:12px;padding:9px 14px;cursor:pointer;transition:transform .15s, box-shadow .2s}
    .btn:hover{box-shadow:var(--glow)}
    .btn:active{transform:translateY(1px)}
    .seg{display:inline-flex;border:1px solid var(--br);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,var(--panel),var(--panel-2))}
    .seg button{padding:8px 12px;border:0;background:transparent;color:var(--text);cursor:pointer}
    .seg button.active{background:rgba(255,255,255,.06);box-shadow:inset 0 0 0 9999px rgba(57,224,178,.08)}

    .wrap{max-width:1200px;margin:0 auto;padding:14px;flex:1}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:10px 0 8px}
    .left, .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--br);background:var(--panel);color:var(--muted)}
    .toggle{display:flex;align-items:center;gap:8px;border:1px solid var(--br);background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:12px;padding:4px 8px}
    .toggle input{appearance:none;width:42px;height:22px;border-radius:999px;background:var(--panel-2);border:1px solid var(--br);position:relative;cursor:pointer}
    .toggle input:checked{background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .toggle input::after{content:"";position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;left:3px;top:2.5px;transition:transform .2s}
    .toggle input:checked::after{transform:translateX(20px)}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--br);background:linear-gradient(180deg,var(--panel),var(--panel-2));color:var(--text);
      border-radius:12px;padding:6px 10px;cursor:pointer}
    .chip.active{box-shadow:var(--glow)}

    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width:1000px){ .grid{grid-template-columns:1fr 1fr} }

    .card{border:1px solid var(--br);border-radius:var(--r);background:linear-gradient(180deg,var(--panel),var(--panel-2));
      box-shadow:var(--shadow);padding:12px;animation:fadeIn .35s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .card h3{margin:0 0 10px;display:flex;align-items:center;gap:10px;font-size:15px}
    .muted{color:var(--muted);font-size:12px}
    .subbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    .pill{padding:6px 10px;border:1px solid var(--br);background:var(--panel);border-radius:999px;display:inline-flex;gap:8px}
    .chart{height:44vh;min-height:260px;border-radius:12px;overflow:hidden;background:var(--chart)}
    @media (min-width:1000px){ .chart{height:36vh} }
    .skeleton{position:relative;border:1px dashed var(--grid);border-radius:12px;height:44vh;min-height:260px;overflow:hidden}
    @media (min-width:1000px){ .skeleton{height:36vh} }
    .skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);transform:translateX(-100%);animation:sh 1.25s infinite}
    @keyframes sh{to{transform:translateX(100%)}}
    .hidden{display:none !important}

    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%) translateY(12px);background:var(--panel);border:1px solid var(--br);
      padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .18s, transform .18s;z-index:50}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    .foot{padding:14px;text-align:center;color:var(--muted);font-size:12px}
  </style>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js" defer></script>
  <script>
    // Блокируем жесты масштабирования (iOS/Android)
    document.addEventListener('gesturestart', e => e.preventDefault());
    document.addEventListener('dblclick', e => e.preventDefault(), {passive:false});
  </script>
</head>
<body>
<div class="app">
  <!-- Верхняя панель -->
  <header class="appbar">
    <div class="appbar-inner">
      <h1 class="title"><span class="dot"></span> TON & SOL — Charts</h1>
      <div class="actions">
        <div class="seg" id="typeSeg" role="tablist" aria-label="Тип графика">
          <button id="btnCandles" class="active" role="tab" aria-selected="true">Свечи</button>
          <button id="btnLine" role="tab" aria-selected="false">Линия</button>
        </div>
        <button class="btn" id="btnRefresh">↻ Обновить</button>
        <div class="seg" id="themeSeg" role="tablist" aria-label="Тема">
          <button id="btnDark" class="active" role="tab" aria-selected="true">Тёмная</button>
          <button id="btnLight" role="tab" aria-selected="false">Светлая</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="appRoot">
    <!-- Верхняя панель статуса/таймфреймов -->
    <div class="toolbar">
      <div class="left">
        <span class="badge" id="status">Статус: загрузка…</span>
        <span class="badge">TF: <span id="tfLabel">1m</span></span>
        <span class="badge">Тип: <span id="typeLabel">Candles</span></span>
      </div>
      <div class="right">
        <div class="chips" id="tfChips" role="tablist" aria-label="Таймфрейм">
          <button class="chip active" data-int="1m" role="tab" aria-selected="true">1m</button>
          <button class="chip" data-int="5m" role="tab">5m</button>
          <button class="chip" data-int="15m" role="tab">15m</button>
        </div>
        <label class="toggle" title="Live обновление">
          <input id="liveSwitch" type="checkbox" checked>
          <span class="muted">Live</span>
        </label>
      </div>
    </div>

    <!-- Переключатели видимости -->
    <div class="toolbar" style="margin-top:0">
      <div class="left">
        <label class="toggle"><input id="toggleTon" type="checkbox" checked><span class="muted">Показать TON</span></label>
        <label class="toggle"><input id="toggleSol" type="checkbox" checked><span class="muted">Показать SOL</span></label>
        <label class="toggle"><input id="toggleIdx" type="checkbox" checked><span class="muted">Показать INDEX</span></label>
      </div>
      <div class="right">
        <span class="badge"><a href="https://api.mexc.com" target="_blank" rel="noreferrer">Источник: MEXC</a></span>
      </div>
    </div>

    <!-- Карточки -->
    <div class="grid">
      <section id="cardTon" class="card" aria-label="График TON">
        <h3>TON/USDT</h3>
        <div class="subbar">
          <span class="pill">Now: <b id="tonNow">—</b></span>
          <span class="muted" id="tonTime">—</span>
        </div>
        <div id="tonChart" class="chart" aria-hidden="false"></div>
        <div id="tonSkel" class="skeleton" aria-hidden="true"></div>
      </section>

      <section id="cardSol" class="card" aria-label="График SOL">
        <h3>SOL/USDT</h3>
        <div class="subbar">
          <span class="pill">Now: <b id="solNow">—</b></span>
          <span class="muted" id="solTime">—</span>
        </div>
        <div id="solChart" class="chart"></div>
        <div id="solSkel" class="skeleton"></div>
      </section>
    </div>

    <section id="cardIdx" class="card" style="margin-top:14px" aria-label="Индекс TON/SOL">
      <h3>INDEX = TON / SOL × 100</h3>
      <div class="subbar">
        <span class="pill">Now: <b id="idxNow">—</b></span>
        <span class="muted" id="idxTime">—</span>
      </div>
      <div id="idxChart" class="chart"></div>
      <div id="idxSkel" class="skeleton"></div>
      <div class="muted" style="margin-top:6px">История из <code>/klines</code>, live — по <code>bookTicker</code>. Свечи по умолчанию, можно переключить на линию.</div>
    </section>
  </main>

  <footer class="foot">
    © TON/SOL Charts • PWA • Без масштабирования • <span id="installHint" class="muted"></span>
  </footer>
</div>

<div id="toast" class="toast">Сообщение</div>

<script>
  // ====== PWA install prompt ======
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;document.getElementById('installHint').textContent='Можно установить как приложение: добавьте на экран.';});
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

  // ====== Helpers/UI ======
  const $ = id => document.getElementById(id);
  const qsa = (sel, root=document) => [...root.querySelectorAll(sel)];
  const fmt = (n,p=6)=> (n==null?"—":(+n).toFixed(p).replace(/\.?0+$/,""));
  const tsFmt = s => { const d=new Date(s*1000); return d.toISOString().replace('T',' ').slice(0,19)+' UTC'; };
  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() }
  function setStatus(text, ok=true){ const el=$("status"); el.textContent="Статус: "+text; el.style.color= ok ? "var(--ok)" : "var(--err)"; }
  function toast(msg, ms=2000){ const el=$("toast"); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), ms); }
  function showSk(id){ const el=$(id); if(el) el.style.display="block"; }
  function hideSk(id){ const el=$(id); if(el) el.style.display="none"; }

  // ====== Theme ======
  function applyTheme(mode){
    document.documentElement.setAttribute('data-theme', mode);
    localStorage.setItem('theme', mode);
    // Переключаем активные кнопки
    $("btnDark").classList.toggle('active', mode==='dark');
    $("btnLight").classList.toggle('active', mode==='light');
    // Обновляем стили чартов
    Object.values(Charts).forEach(obj => obj.chart && obj.chart.applyOptions(themeChartOpts()));
  }
  function setupTheme(){
    const saved = localStorage.getItem('theme');
    const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
    applyTheme(saved || (prefersLight?'light':'dark'));
    $("btnDark").addEventListener('click', ()=>applyTheme('dark'));
    $("btnLight").addEventListener('click', ()=>applyTheme('light'));
  }

  // ====== API & proxies ======
  const API_BASE = "https://api.mexc.com/api/v3";
  const PROXIES = [
    (u) => `https://cors.isomorphic-git.org/${u}`,
    (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
    (u) => `https://r.jina.ai/http/${u.replace(/^https?:\/\//,'')}`
  ];
  const TON = "TONUSDT", SOL = "SOLUSDT";
  const LIMIT = 500;

  async function viaProxies(url, tries=3){
    let lastErr;
    for(let round=0; round<tries; round++){
      for(const build of PROXIES){
        const proxied = build(url);
        try{
          const r = await fetch(proxied, { cache:'no-store' });
          if(!r.ok) throw new Error(`HTTP ${r.status}`);
          const text = await r.text();
          let data; try { data = JSON.parse(text); } catch { data = JSON.parse(text.replace(/^[^{\[]+/,'')); }
          return data;
        }catch(e){ lastErr=e; await new Promise(res=>setTimeout(res, 250*(round+1))); }
      }
    }
    throw lastErr || new Error('All proxies failed');
  }
  const apiUrl = (q)=>`${API_BASE}/${q}`;
  const mexcJSON = (path)=> viaProxies(apiUrl(path), 3);

  // ====== Charts ======
  const Charts = { ton:{}, sol:{}, idx:{} };
  let INTERVAL = "1m";
  let CHART_TYPE = "candles";
  let liveTimer = null;

  function themeChartOpts(){
    return {
      layout:{ background:{type:'solid', color:getVar('--chart')}, textColor:getVar('--text') },
      rightPriceScale:{ borderColor:getVar('--grid') },
      timeScale:{ borderColor:getVar('--grid'), timeVisible:true, secondsVisible:false, rightOffset:6, barSpacing:8 },
      grid:{ vertLines:{color:getVar('--grid')}, horzLines:{color:getVar('--grid')} },
      crosshair:{ mode:LightweightCharts.CrosshairMode.Magnet },
      handleScale:{ mouseWheel:true, pinch:true, axisPressedMouseMove:true },
      kineticScroll:{ mouse:true, touch:true },
    };
  }
  function createChart(container){
    const c = LightweightCharts.createChart(container, themeChartOpts());
    const ro = new ResizeObserver(()=>c.resize(container.clientWidth||600, container.clientHeight||300));
    ro.observe(container);
    return c;
  }
  function setSeries(obj, type){
    if(obj.series){ obj.chart.removeSeries(obj.series); obj.series=null; }
    if(type==='candles'){
      obj.series = obj.chart.addCandlestickSeries({ upColor:'#0ac18e', downColor:'#ff6b6b', wickUpColor:'#0ac18e', wickDownColor:'#ff6b6b', borderVisible:false });
    }else{
      obj.series = obj.chart.addLineSeries({ lineWidth:2 });
    }
    obj.type = type;
  }
  function applyTypeAll(type){
    setSeries(Charts.ton, type);
    setSeries(Charts.sol, type);
    setSeries(Charts.idx, 'line'); // индекс всегда линией
    $("typeLabel").textContent = type==='candles' ? 'Candles' : 'Line';
    $("btnCandles").classList.toggle('active', type==='candles');
    $("btnLine").classList.toggle('active', type==='line');
    $("btnCandles").setAttribute('aria-selected', type==='candles');
    $("btnLine").setAttribute('aria-selected', type==='line');
  }

  async function klines(symbol){
    const j = await mexcJSON(`klines?symbol=${symbol}&interval=${INTERVAL}&limit=${LIMIT}`);
    return j.map(a => ({ time: Math.floor(a[0]/1000), open:+a[1], high:+a[2], low:+a[3], close:+a[4], value:+a[4] }));
  }
  async function bookMid(symbol){
    const j = await mexcJSON(`ticker/bookTicker?symbol=${symbol}`);
    const bid=+j.bidPrice, ask=+j.askPrice; return (bid+ask)/2;
  }

  async function loadHistory(){
    setStatus('загрузка…', true);
    showSk('tonSkel'); showSk('solSkel'); showSk('idxSkel');
    const [t,s] = await Promise.all([klines(TON), klines(SOL)]);

    if(Charts.ton.type==='candles') Charts.ton.series.setData(t.map(p=>({time:p.time,open:p.open,high:p.high,low:p.low,close:p.close})));
    else Charts.ton.series.setData(t.map(p=>({time:p.time,value:p.value})));

    if(Charts.sol.type==='candles') Charts.sol.series.setData(s.map(p=>({time:p.time,open:p.open,high:p.high,low:p.low,close:p.close})));
    else Charts.sol.series.setData(s.map(p=>({time:p.time,value:p.value})));

    // индекс по close/value
    const sm = new Map(s.map(p=>[p.time,p.value]));
    const idx = t.filter(p=>sm.has(p.time)).map(p=>({time:p.time,value:(p.value/sm.get(p.time))*100}));
    Charts.idx.series.setData(idx);

    Charts.ton.chart.timeScale().fitContent();
    Charts.sol.chart.timeScale().fitContent();
    Charts.idx.chart.timeScale().fitContent();

    if (t.length){ const last=t.at(-1); $("tonNow").textContent=fmt(last.value,6); $("tonTime").textContent=tsFmt(last.time); }
    if (s.length){ const last=s.at(-1); $("solNow").textContent=fmt(last.value,6); $("solTime").textContent=tsFmt(last.time); }
    if (idx.length){ const last=idx.at(-1); $("idxNow").textContent=fmt(last.value,4); $("idxTime").textContent=tsFmt(last.time); }

    hideSk('tonSkel'); hideSk('solSkel'); hideSk('idxSkel');
    setStatus('онлайн', true);
  }

  async function liveTickOnce(){
    try{
      const [tm, sm] = await Promise.all([bookMid(TON), bookMid(SOL)]);
      const now = Math.floor(Date.now()/1000);
      const iv = (tm/sm)*100;

      if (Charts.ton.type==='candles') Charts.ton.series.update({time:now, open:tm, high:tm, low:tm, close:tm});
      else Charts.ton.series.update({time:now, value:tm});

      if (Charts.sol.type==='candles') Charts.sol.series.update({time:now, open:sm, high:sm, low:sm, close:sm});
      else Charts.sol.series.update({time:now, value:sm});

      Charts.idx.series.update({time:now, value:iv});

      $("tonNow").textContent=fmt(tm,6);
      $("solNow").textContent=fmt(sm,6);
      $("idxNow").textContent=fmt(iv,4);
      const t=tsFmt(now); $("tonTime").textContent=t; $("solTime").textContent=t; $("idxTime").textContent=t;
      setStatus('онлайн', true);
    }catch(e){ setStatus('прокси медлит…', false); }
  }
  function startLive(){ stopLive(); if ($("liveSwitch").checked){ liveTimer = setInterval(liveTickOnce, 1000); } }
  function stopLive(){ if (liveTimer){ clearInterval(liveTimer); liveTimer=null; } }

  // ====== INIT ======
  window.addEventListener('DOMContentLoaded', async () => {
    if (!window.LightweightCharts || typeof LightweightCharts.createChart !== 'function'){
      toast('Библиотека графиков не загрузилась'); setStatus('ошибка библиотеки', false); return;
    }
    setupTheme();

    // создаём чарты
    Charts.ton.chart = createChart($("tonChart"));
    Charts.sol.chart = createChart($("solChart"));
    Charts.idx.chart = createChart($("idxChart"));
    applyTypeAll('candles'); // по умолчанию свечи

    // UI events
    $("btnRefresh").addEventListener('click', async ()=>{ toast('⏳ Обновляю…'); await loadHistory(); await liveTickOnce(); });

    $("btnCandles").addEventListener('click', async ()=>{ if(CHART_TYPE==='candles')return; CHART_TYPE='candles'; applyTypeAll('candles'); await loadHistory(); });
    $("btnLine").addEventListener('click', async ()=>{ if(CHART_TYPE==='line')return; CHART_TYPE='line'; applyTypeAll('line'); await loadHistory(); });

    $("liveSwitch").addEventListener('change', ()=> startLive());

    qsa('#tfChips .chip').forEach(ch=>{
      ch.addEventListener('click', async ()=>{
        qsa('#tfChips .chip').forEach(c=>c.classList.remove('active'));
        ch.classList.add('active');
        INTERVAL = ch.dataset.int || '1m';
        $("tfLabel").textContent = INTERVAL;
        toast('Таймфрейм: '+INTERVAL);
        await loadHistory();
      });
    });

    $("toggleTon").addEventListener('change', ()=> $("cardTon").classList.toggle('hidden', !$("toggleTon").checked));
    $("toggleSol").addEventListener('change', ()=> $("cardSol").classList.toggle('hidden', !$("toggleSol").checked));
    $("toggleIdx").addEventListener('change', ()=> $("cardIdx").classList.toggle('hidden', !$("toggleIdx").checked));

    try{
      await loadHistory();
      startLive();
    }catch(e){
      console.error(e);
      setStatus('ошибка инициализации (прокси)', false);
      toast('Публичные прокси недоступны. Перезагрузите позже.');
    }
  });
</script>
</body>
</html>
